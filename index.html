<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pr√°cticas guiadas ‚Äì Sesi√≥n 4</title>

<style>
body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#1a1a1a,#0b0b0b);
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
}

.logo{margin-top:20px;}
.logo img{width:140px;opacity:.95;}

h1{margin:18px 0 4px;color:#4ade80;}
h2{
  margin:0;
  font-style:italic;
  font-weight:normal;
  font-size:16px;
  color:#a855f7;
}

.exercise{margin-top:22px;font-size:20px;}

.rows{margin:28px 0;}
.row{
  display:flex;
  justify-content:space-between;
  width:420px;
  margin:8px auto;
}

.time{
  width:40px;
  font-size:22px;
  opacity:.35;
  transition:.1s;
}
.time.active{opacity:1;transform:scale(1.2);}

.arrow{
  width:40px;
  font-size:32px;
  opacity:.35;
  transition:.1s;
}
.arrow.down{color:#22c55e;}
.arrow.up{color:#a855f7;}
.arrow.active{
  opacity:1;
  transform:scale(1.25);
  text-shadow:0 0 12px currentColor;
}

.controls{margin-top:10px;}
button{
  background:#22c55e;
  color:#000;
  border:none;
  padding:14px 30px;
  font-size:18px;
  border-radius:14px;
  margin:10px;
  cursor:pointer;
}
button:active{transform:scale(.96);}

input[type=range]{width:300px;accent-color:#a855f7;}

.info{
  margin-top:30px;
  font-size:14px;
  opacity:.7;
  max-width:420px;
}
</style>
</head>

<body>

<div class="logo">
  <img src="https://static.wixstatic.com/media/b4a607_0927246f3864402c8d6d2d56723b8bba~mv2.png">
</div>

<h1>Pr√°cticas guiadas ‚Äì Sesi√≥n 4</h1>
<h2>El motor ya est√° en marcha</h2>

<div class="exercise"><strong>Rasgueo Inicial (B√°sico)</strong></div>

<div class="rows">
  <div class="row" id="times"></div>
  <div class="row" id="arrows"></div>
</div>

<div class="controls">
  <button id="play">Play / Stop</button><br><br>
  <input type="range" id="bpm" min="30" max="70" value="40">
  <div>BPM: <span id="bpmVal">40</span></div>
</div>

<div class="info">
Los sonidos no corresponden a ning√∫n acorde.<br>
Son cuerdas al aire como referencia r√≠tmica.
</div>

<script>
let audioCtx, downBuffer, upBuffer;
let playing=false, step=0, nextTime=0, timer;

const pattern=[
 {l:"1",t:"down",strong:true},
 {l:"y",t:"up",strong:false},
 {l:"2",t:"down",strong:false},
 {l:"y",t:"up",strong:false},
 {l:"3",t:"down",strong:false},
 {l:"y",t:"up",strong:false},
 {l:"4",t:"down",strong:false},
 {l:"y",t:"up",strong:false}
];

const GAIN_STRONG=.9, GAIN_DOWN=.6, GAIN_UP=.45;
const lookAhead=.1, visualOffset=-.012;

const times=document.getElementById("times");
const arrows=document.getElementById("arrows");

pattern.forEach(p=>{
  const t=document.createElement("div");
  t.className="time"; t.textContent=p.l;
  times.appendChild(t);

  const a=document.createElement("div");
  a.className="arrow "+p.t;
  a.textContent=p.t==="down"?"‚Üì":"‚Üë";
  arrows.appendChild(a);
});

const timeEls=document.querySelectorAll(".time");
const arrowEls=document.querySelectorAll(".arrow");

function highlight(i){
  timeEls.forEach(e=>e.classList.remove("active"));
  arrowEls.forEach(e=>e.classList.remove("active"));
  timeEls[i].classList.add("active");
  arrowEls[i].classList.add("active");
}

async function loadSample(u){
  const r=await fetch(u);
  return await audioCtx.decodeAudioData(await r.arrayBuffer());
}

function playStrum(buf,time,g){
  const s=audioCtx.createBufferSource();
  const gn=audioCtx.createGain();
  s.buffer=buf;
  gn.gain.setValueAtTime(0,time);
  gn.gain.linearRampToValueAtTime(g,time+.004);
  gn.gain.linearRampToValueAtTime(0,time+buf.duration);
  s.connect(gn).connect(audioCtx.destination);
  s.start(time);
}

function scheduler(){
  const bpm=+bpmSlider.value;
  const interval=60/bpm/2;

  while(nextTime<audioCtx.currentTime+lookAhead){
    const p=pattern[step];
    const gain=p.strong?GAIN_STRONG:(p.t==="down"?GAIN_DOWN:GAIN_UP);

    playStrum(
      p.t==="down"?downBuffer:upBuffer,
      nextTime,
      gain
    );

    const d=(nextTime-audioCtx.currentTime+visualOffset)*1000;
    setTimeout(()=>highlight(step),d);

    nextTime+=interval;
    step=(step+1)%pattern.length;
  }
}

const playBtn=document.getElementById("play");
const bpmSlider=document.getElementById("bpm");
const bpmVal=document.getElementById("bpmVal");
bpmSlider.oninput=()=>bpmVal.textContent=bpmSlider.value;

playBtn.onclick=async()=>{
  if(!audioCtx){
    audioCtx=new AudioContext();
    downBuffer=await loadSample("down.wav");
    upBuffer=await loadSample("up.wav");
  }

  if(!playing){
    playing=true;

    const bpm=+bpmSlider.value;
    const interval=60/bpm/2;

    // üî• DISPARO INICIAL CORRECTO
    playStrum(downBuffer,audioCtx.currentTime,GAIN_STRONG);
    highlight(0);

    step=1;
    nextTime=audioCtx.currentTime+interval;
    timer=setInterval(scheduler,25);

  }else{
    playing=false;
    clearInterval(timer);
    timeEls.forEach(e=>e.classList.remove("active"));
    arrowEls.forEach(e=>e.classList.remove("active"));
  }
};
</script>

</body>
</html>
