<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prácticas guiadas – Sesión 4</title>

  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
    }

    h1 {
      margin-bottom: 4px;
    }

    h2 {
      margin-top: 0;
      font-style: italic;
      font-weight: normal;
      color: #a855f7;
    }

    .timeline, .arrows {
      display: flex;
      justify-content: space-between;
      max-width: 640px;
      margin: 30px auto 0;
    }

    .time {
      width: 40px;
      font-size: 22px;
      opacity: 0.35;
      transition: all 0.1s ease;
    }

    .time.active {
      opacity: 1;
      transform: scale(1.15);
    }

    .arrows {
      margin-top: 10px;
      font-size: 32px;
    }

    .arrow {
      width: 40px;
      opacity: 0.35;
      transition: all 0.1s ease;
    }

    .arrow.down {
      color: #22c55e;
    }

    .arrow.up {
      color: #a855f7;
    }

    .arrow.active {
      opacity: 1;
      transform: scale(1.2);
      text-shadow: 0 0 10px currentColor;
    }

    .controls {
      margin-top: 40px;
    }

    button {
      background: #000;
      color: #fff;
      border: none;
      padding: 14px 26px;
      font-size: 18px;
      border-radius: 8px;
      margin: 0 10px;
      cursor: pointer;
    }

    button:active {
      transform: scale(0.95);
    }

    input[type="range"] {
      width: 300px;
      margin-top: 20px;
    }

    .info {
      max-width: 640px;
      margin: 30px auto 0;
      font-size: 14px;
      opacity: 0.7;
      line-height: 1.4;
    }
  </style>
</head>

<body>

  <h1>Prácticas guiadas – Sesión 4</h1>
  <h2>El motor ya está en marcha</h2>

  <div class="timeline" id="times"></div>
  <div class="arrows" id="arrows"></div>

  <div class="controls">
    <button id="play">Play</button>
    <button id="stop">Stop</button><br><br>

    <input type="range" id="bpm" min="30" max="70" value="40">
    <div>BPM: <span id="bpmValue">40</span></div>
  </div>

  <div class="info">
    Los sonidos no corresponden a ningún acorde.<br>
    Son cuerdas tocadas al aire y se usan solo como referencia rítmica.
  </div>

<script>
/* =========================
   AUDIO CONTEXT
========================= */
let audioCtx;
let downBuffer, upBuffer;

/* =========================
   CONFIGURACIÓN
========================= */
const pattern = [
  { label: "1", type: "down" },
  { label: "y", type: "up" },
  { label: "2", type: "down" },
  { label: "y", type: "up" },
  { label: "3", type: "down" },
  { label: "y", type: "up" },
  { label: "4", type: "down" },
  { label: "y", type: "up" }
];

const GAIN_DOWN = 0.75;
const GAIN_UP   = 0.48;

const lookAhead = 0.1;        // 100 ms
const visualOffset = -0.012;  // -12 ms

let isPlaying = false;
let currentStep = 0;
let nextEventTime = 0;
let schedulerId;

/* =========================
   CARGA DE AUDIOS
========================= */
async function loadSample(url) {
  const res = await fetch(url);
  const arrayBuffer = await res.arrayBuffer();
  return await audioCtx.decodeAudioData(arrayBuffer);
}

async function loadSamples() {
  downBuffer = await loadSample("down.wav");
  upBuffer   = await loadSample("up.wav");
}

/* =========================
   VISUAL
========================= */
const timesDiv = document.getElementById("times");
const arrowsDiv = document.getElementById("arrows");

pattern.forEach(p => {
  const t = document.createElement("div");
  t.className = "time";
  t.textContent = p.label;
  timesDiv.appendChild(t);

  const a = document.createElement("div");
  a.className = "arrow " + p.type;
  a.textContent = p.type === "down" ? "↓" : "↑";
  arrowsDiv.appendChild(a);
});

const timeEls = document.querySelectorAll(".time");
const arrowEls = document.querySelectorAll(".arrow");

function highlight(step) {
  timeEls.forEach(el => el.classList.remove("active"));
  arrowEls.forEach(el => el.classList.remove("active"));

  timeEls[step].classList.add("active");
  arrowEls[step].classList.add("active");
}

/* =========================
   AUDIO
========================= */
function playStrum(buffer, time, gainValue) {
  const source = audioCtx.createBufferSource();
  source.buffer = buffer;

  const gain = audioCtx.createGain();
  gain.gain.value = gainValue;

  source.connect(gain).connect(audioCtx.destination);
  source.start(time);
}

/* =========================
   SCHEDULER
========================= */
function scheduler() {
  const bpm = +bpmSlider.value;
  const interval = 60 / bpm / 2; // corcheas

  while (nextEventTime < audioCtx.currentTime + lookAhead) {
    const step = currentStep;
    const isDown = pattern[step].type === "down";

    playStrum(
      isDown ? downBuffer : upBuffer,
      nextEventTime,
      isDown ? GAIN_DOWN : GAIN_UP
    );

    const now = audioCtx.currentTime;
    const delay = (nextEventTime - now + visualOffset) * 1000;

    setTimeout(() => highlight(step), delay);

    nextEventTime += interval;
    currentStep = (currentStep + 1) % pattern.length;
  }
}

/* =========================
   CONTROLES
========================= */
const playBtn = document.getElementById("play");
const stopBtn = document.getElementById("stop");
const bpmSlider = document.getElementById("bpm");
const bpmValue = document.getElementById("bpmValue");

bpmSlider.oninput = () => bpmValue.textContent = bpmSlider.value;

playBtn.onclick = async () => {
  if (isPlaying) return;

  if (!audioCtx) {
    audioCtx = new AudioContext();
    await loadSamples();
  }

  isPlaying = true;
  currentStep = 0;
  nextEventTime = audioCtx.currentTime + 0.05;

  schedulerId = setInterval(scheduler, 25);
};

stopBtn.onclick = () => {
  isPlaying = false;
  clearInterval(schedulerId);

  timeEls.forEach(el => el.classList.remove("active"));
  arrowEls.forEach(el => el.classList.remove("active"));
};
</script>

</body>
</html>
