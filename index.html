<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Prácticas guiadas – Sesión 4</title>

<style>
body {
  background:#111;
  color:#fff;
  font-family:Arial,sans-serif;
  text-align:center;
  padding:20px;
}

h1 { margin-bottom:5px; }
h2 {
  margin-top:0;
  font-style:italic;
  font-weight:normal;
  color:#a855f7;
}

.row {
  display:flex;
  justify-content:space-between;
  max-width:600px;
  margin:30px auto 0;
}

.time {
  width:40px;
  font-size:22px;
  opacity:.35;
  transition:.1s;
}

.time.active {
  opacity:1;
  transform:scale(1.15);
}

.arrow {
  width:40px;
  font-size:32px;
  opacity:.35;
  transition:.1s;
}

.arrow.down { color:#22c55e; }
.arrow.up { color:#a855f7; }

.arrow.active {
  opacity:1;
  transform:scale(1.2);
  text-shadow:0 0 10px currentColor;
}

.controls {
  margin-top:40px;
}

button {
  background:#000;
  color:#fff;
  border:none;
  padding:14px 26px;
  font-size:18px;
  border-radius:8px;
  margin:0 10px;
  cursor:pointer;
}

button:active { transform:scale(.95); }

input[type=range] {
  width:280px;
  margin-top:20px;
}

.info {
  margin-top:30px;
  font-size:14px;
  opacity:.7;
}
</style>
</head>

<body>

<h1>Prácticas guiadas – Sesión 4</h1>
<h2>El motor ya está en marcha</h2>

<div class="row" id="times"></div>
<div class="row" id="arrows"></div>

<div class="controls">
  <button id="play">Play</button>
  <button id="stop">Stop</button><br><br>
  <input type="range" id="bpm" min="30" max="70" value="40">
  <div>BPM: <span id="bpmVal">40</span></div>
</div>

<div class="info">
Los sonidos no corresponden a ningún acorde.<br>
Son cuerdas al aire como referencia rítmica.
</div>

<script>
let audioCtx, downBuffer, upBuffer;
let isPlaying=false, step=0, nextTime=0, timer;

const pattern=[
 {l:"1",t:"down"},{l:"y",t:"up"},
 {l:"2",t:"down"},{l:"y",t:"up"},
 {l:"3",t:"down"},{l:"y",t:"up"},
 {l:"4",t:"down"},{l:"y",t:"up"}
];

const G_DOWN=.75, G_UP=.48;
const lookAhead=.1, visualOffset=-.012;

const times=document.getElementById("times");
const arrows=document.getElementById("arrows");

pattern.forEach(p=>{
  const t=document.createElement("div");
  t.className="time"; t.textContent=p.l;
  times.appendChild(t);

  const a=document.createElement("div");
  a.className="arrow "+p.t;
  a.textContent=p.t==="down"?"↓":"↑";
  arrows.appendChild(a);
});

const timeEls=document.querySelectorAll(".time");
const arrowEls=document.querySelectorAll(".arrow");

function highlight(i){
  timeEls.forEach(e=>e.classList.remove("active"));
  arrowEls.forEach(e=>e.classList.remove("active"));
  timeEls[i].classList.add("active");
  arrowEls[i].classList.add("active");
}

async function loadSample(u){
  const r=await fetch(u);
  return await audioCtx.decodeAudioData(await r.arrayBuffer());
}

function playStrum(buf,time,g){
  const s=audioCtx.createBufferSource();
  const gn=audioCtx.createGain();
  s.buffer=buf;

  gn.gain.setValueAtTime(0,time);
  gn.gain.linearRampToValueAtTime(g,time+.005);
  gn.gain.linearRampToValueAtTime(0,time+buf.duration);

  s.connect(gn).connect(audioCtx.destination);
  s.start(time);
}

function scheduler(){
  const bpm=+bpmSlider.value;
  const intv=60/bpm/2;

  while(nextTime<audioCtx.currentTime+lookAhead){
    const p=pattern[step];
    playStrum(p.t==="down"?downBuffer:upBuffer,
              nextTime,
              p.t==="down"?G_DOWN:G_UP);

    const d=(nextTime-audioCtx.currentTime+visualOffset)*1000;
    setTimeout(()=>highlight(step),d);

    nextTime+=intv;
    step=(step+1)%pattern.length;
  }
}

const playBtn=document.getElementById("play");
const stopBtn=document.getElementById("stop");
const bpmSlider=document.getElementById("bpm");
const bpmVal=document.getElementById("bpmVal");

bpmSlider.oninput=()=>bpmVal.textContent=bpmSlider.value;

playBtn.onclick=async()=>{
  if(isPlaying) return;
  if(!audioCtx){
    audioCtx=new AudioContext();
    downBuffer=await loadSample("down.wav");
    upBuffer=await loadSample("up.wav");
  }
  isPlaying=true;
  step=0;
  nextTime=audioCtx.currentTime+.05;
  timer=setInterval(scheduler,25);
};

stopBtn.onclick=()=>{
  isPlaying=false;
  clearInterval(timer);
  timeEls.forEach(e=>e.classList.remove("active"));
  arrowEls.forEach(e=>e.classList.remove("active"));
};
</script>

</body>
</html>
